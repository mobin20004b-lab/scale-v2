generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String        @id @default(cuid())
  name       String
  username   String        @unique
  email      String        @unique
  password   String
  role       UserRole      @default(WAREHOUSE_OPERATOR)
  status     UserStatus    @default(ACTIVE)
  isActive   Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  accounts   Account[]
  activities ActivityLog[]
  sessions   Session[]
}

model Product {
  id            String            @id @default(cuid())
  name          String
  nameFa        String?
  description   String?
  descriptionFa String?
  barcode       String            @unique
  qrCode        String            @unique
  category      String?
  unit          String            @default("kg")
  isDeleted     Boolean           @default(false)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  ledgerEntries InventoryLedger[]
}

model Warehouse {
  id            String            @id @default(cuid())
  name          String
  location      String?
  managerName   String?
  capacityKg    Float             @default(0)
  status        WarehouseStatus   @default(ACTIVE)
  isDeleted     Boolean           @default(false)
  deletedAt     DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  ledgerEntries InventoryLedger[]
  scales        Scale[]
}

model Scale {
  id              String            @id @default(cuid())
  name            String
  model           String            @default("ESP32-WROOM-32")
  firmwareVersion String            @default("1.0.0")
  apiKey          String            @unique
  status          ScaleStatus       @default(OFFLINE)
  signal          SignalStatus      @default(STALE)
  currentWeight   Float             @default(0)
  unit            String            @default("kg")
  precision       Int               @default(2)
  heartbeat       Int               @default(30)
  uptimeSec       Int               @default(0)
  lastSeen        DateTime?
  warehouseId     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ledgerEntries   InventoryLedger[]
  printJobs       PrintJob[]
  warehouse       Warehouse         @relation(fields: [warehouseId], references: [id])
  commands        ScaleCommand[]
}

model InventoryLedger {
  id          String     @id @default(cuid())
  type        LedgerType
  quantity    Float
  weight      Float?
  sourceTxId  String?
  createdAt   DateTime   @default(now())
  createdBy   String?
  productId   String
  warehouseId String
  scaleId     String?
  product     Product    @relation(fields: [productId], references: [id])
  scale       Scale?     @relation(fields: [scaleId], references: [id])
  warehouse   Warehouse  @relation(fields: [warehouseId], references: [id])
}

model UnknownBarcode {
  id         String               @id @default(cuid())
  barcode    String
  status     UnknownBarcodeStatus @default(OPEN)
  capturedAt DateTime             @default(now())
  resolvedAt DateTime?
  resolvedTo String?
}

model ScaleCommand {
  id        String             @id @default(cuid())
  scaleId   String
  command   String
  status    ScaleCommandStatus @default(PENDING)
  createdAt DateTime           @default(now())
  sentAt    DateTime?
  ackedAt   DateTime?
  scale     Scale              @relation(fields: [scaleId], references: [id])
}

model PrintJob {
  id        String         @id @default(cuid())
  scaleId   String
  payload   String
  status    PrintJobStatus @default(QUEUED)
  attempts  Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  scale     Scale          @relation(fields: [scaleId], references: [id])
}

model ActivityLog {
  id         String   @id @default(cuid())
  actorId    String?
  action     String
  entityType String
  entityId   String?
  details    String?
  createdAt  DateTime @default(now())
  actor      User?    @relation(fields: [actorId], references: [id])
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  CEO
  WAREHOUSE_MANAGER
  WAREHOUSE_OPERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum WarehouseStatus {
  ACTIVE
  ARCHIVED
}

enum ScaleStatus {
  ONLINE
  OFFLINE
  ARCHIVED
}

enum SignalStatus {
  FRESH
  STALE
}

enum LedgerType {
  STOCK_IN
  STOCK_IN_UNDO
  STOCK_OUT
  STOCK_OUT_UNDO
}

enum UnknownBarcodeStatus {
  OPEN
  TEMP_RECEIVING
  MAPPED
}

enum ScaleCommandStatus {
  PENDING
  SENT
  ACKED
  FAILED
  EXPIRED
}

enum PrintJobStatus {
  QUEUED
  SENT
  FAILED
  REPRINT
}
